<html><head><base href="/" />
<title>Multi-Chain DApp</title>
<script src="https://cdn.jsdelivr.net/npm/web3@1.6.0/dist/web3.min.js"></script>
<style>
/* Reset styles for consistency */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html, body {
    height: 100%;
    width: 100%;
    overflow-x: hidden;
}

:root {
    --primary: #2D3748;
    --secondary: #4A5568;
    --accent: #6B46C1;
    --sidebar-width: 200px;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, sans-serif;
    background: #f7fafc;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    width: 100vw;
    overflow-x: hidden;
}

.container {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    width: 90%;
    max-width: 1200px;
    min-height: fit-content;
    height: 80vh;
    max-height: 600px;
    display: flex;
    overflow: auto;
    margin: auto;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.sidebar {
    width: var(--sidebar-width);
    background: var(--primary);
    padding: 2rem 1rem;
    border-radius: 16px 0 0 16px;
    color: white;
    position: relative;
    min-height: 500px;
    display: flex;
    flex-direction: column;
}

.main-content {
    flex: 1;
    padding: 2rem;
    position: relative;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--secondary) transparent;
}

.header {
    text-align: center;
    margin-bottom: 2rem;
}

.header h1 {
    margin-bottom: 0.5rem;
    color: var(--primary);
}

.header p {
    color: var(--secondary);
    margin-bottom: 2rem;
}

.network-btn {
    width: 100%;
    padding: 1rem;
    margin-bottom: 1rem;
    border: none;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: left;
}

.network-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateX(5px);
}

.network-btn.active {
    background: #000000;
    border: 2px solid #40E0D0;
    box-shadow: 0 4px 6px rgba(64, 224, 208, 0.2);
}

.products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
}

.product-card {
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    background: #f8fafc;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.product-info {
    margin-bottom: 1rem;
    width: 100%;
    text-align: center;
}

.product-info h2 {
    color: var(--primary);
    margin-bottom: 0.5rem;
    text-align: center;
}

.product-info p {
    color: var(--secondary);
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
    text-align: center;
}

.quantity-selector {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin: 1rem 0;
    justify-content: center;
}

.quantity-btn {
    background: var(--secondary);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 0.5rem 1rem;
    cursor: pointer;
}

.buy-btn {
    background: #000000;
    color: white;
    border: 2px solid #40E0D0;
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    cursor: pointer;
    width: 100%;
    font-weight: bold;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(64, 224, 208, 0.2);
}

.buy-btn:hover {
    background: #333333;
    box-shadow: 0 6px 8px rgba(64, 224, 208, 0.3);
}

.logo-container {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 120px;
    height: 120px;
    display: flex;
    justify-content: center;
    align-items: center;
}

.logo {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #40E0D0;
    box-shadow: 0 4px 6px rgba(64, 224, 208, 0.2);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.logo:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 8px rgba(64, 224, 208, 0.3);
}

#wallet-status {
    font-size: 0.9rem;
    margin-bottom: 1rem;
    color: white;
    text-align: center;
}

.contract-address {
    font-size: 0.8rem;
    color: var(--secondary);
    word-break: break-all;
    text-align: center;
    width: 100%;
}

.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    max-width: 300px;
    z-index: 1000;
    padding: 10px;
}

.custom-toast {
    background: white;
    color: #2D3748;
    padding: 12px 20px;
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    justify-content: space-between;
    animation: slideIn 0.3s ease-out;
    border-left: 4px solid;
}

.custom-toast.success {
    border-left-color: #48BB78;
}

.custom-toast.error {
    border-left-color: #F56565;
}

/* Enhanced scrollbar styling */
.main-content::-webkit-scrollbar {
    width: 8px;
}

.main-content::-webkit-scrollbar-track {
    background: transparent;
}

.main-content::-webkit-scrollbar-thumb {
    background-color: var(--secondary);
    border-radius: 4px;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Responsive adjustments */
@media screen and (max-width: 1024px) {
    .container {
        width: 95%;
        height: 85vh;
    }
}

@media screen and (max-width: 768px) {
    .container {
        width: 98%;
        height: 90vh;
    }
    
    .sidebar {
        width: 160px;
    }
    
    .products-grid {
        grid-template-columns: 1fr;
    }
}
</style>
</head>
<body>
  <div class="vending-machine">
    <!-- Header -->
    <header>
      <div class="logo-container">
        <img src="logo.png" alt="Company Logo" class="logo-image">
      </div>
      <div class="network-status" id="network-status">
        Network: Not Connected
      </div>
      <div class="wallet-status" id="wallet-status">
        <button class="btn btn-primary" id="connect-wallet-btn">Connect Wallet</button>
      </div>
    </header>

    <!-- Main Content -->
    <main>
      <!-- Product Listing -->
      <section class="product-listing" id="product-listing">
        <!-- Products will be dynamically loaded here -->
      </section>
    </main>

    <!-- Footer -->
    <footer>
      <p>&copy; 2023 CiFi Vending Machine</p>
    </footer>
  </div>

  <!-- Purchase Modal -->
  <div id="purchase-modal" class="modal">
    <div class="modal-content">
      <h2>Purchase Product</h2>
      <div id="purchase-product-details">
        <!-- Product details will be loaded here -->
      </div>
      <form id="purchase-form">
        <div class="form-group">
          <label>Amount</label>
          <input type="number" name="amount" min="1" value="1" required>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Confirm Purchase</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal('purchase-modal')">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const CONTRACT_ABI = [
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "initialOwner",
				"type": "address"
			}
		],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "OwnableInvalidOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "OwnableUnauthorizedAccount",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "token",
				"type": "address"
			}
		],
		"name": "SafeERC20FailedOperation",
		"type": "error"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "creator",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "status",
				"type": "bool"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "CreatorWhitelisted",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "creator",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "EmergencyWithdrawalExecuted",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "creator",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "EmergencyWithdrawalRequested",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "Paused",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "ipfsCID",
				"type": "string"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "productContract",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "creator",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "beneficiary",
				"type": "address"
			}
		],
		"name": "ProductAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "locked",
				"type": "bool"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "ProductEmergencyLocked",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "isActive",
				"type": "bool"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "ProductStatusChanged",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "newPrice",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "newIpfsCID",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "updater",
				"type": "address"
			}
		],
		"name": "ProductUpdated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "Unpaused",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "EMERGENCY_WITHDRAWAL_DELAY",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "ipfsCID",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "productToken",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "paymentToken",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "beneficiary",
				"type": "address"
			}
		],
		"name": "addProduct",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "depositToProduct",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "emergencyWithdrawalRequested",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "emergencyWithdrawalTime",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			}
		],
		"name": "executeEmergencyWithdrawal",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getAllProductIds",
		"outputs": [
			{
				"internalType": "uint256[]",
				"name": "",
				"type": "uint256[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			}
		],
		"name": "getFullProductDetails",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "name",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "ipfsCID",
						"type": "string"
					},
					{
						"internalType": "address",
						"name": "productToken",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "paymentToken",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "price",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "availableSupply",
						"type": "uint256"
					},
					{
						"internalType": "bool",
						"name": "isActive",
						"type": "bool"
					},
					{
						"internalType": "uint256",
						"name": "totalSold",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "totalRevenue",
						"type": "uint256"
					},
					{
						"internalType": "address",
						"name": "creator",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "beneficiary",
						"type": "address"
					},
					{
						"internalType": "bool",
						"name": "emergencyLocked",
						"type": "bool"
					}
				],
				"internalType": "struct Test2VendingMachine.FullProductDetails",
				"name": "details",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			}
		],
		"name": "getProductBasicInfo",
		"outputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "ipfsCID",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "productContractAddress",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "creator",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "beneficiary",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "isActive",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "emergencyLocked",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "creator",
				"type": "address"
			}
		],
		"name": "isWhitelistedCreator",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "pause",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "paused",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "products",
		"outputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "ipfsCID",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "productContract",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "creator",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "beneficiary",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "isActive",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "emergencyLocked",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "renounceOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			}
		],
		"name": "requestEmergencyWithdrawal",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "creator",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "status",
				"type": "bool"
			}
		],
		"name": "setCreatorWhitelist",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "isActive",
				"type": "bool"
			}
		],
		"name": "setProductStatus",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "unpause",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "newPrice",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "newIpfsCID",
				"type": "string"
			}
		],
		"name": "updateProduct",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "whitelistedCreators",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];
    const ERC20_ABI = [
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "tokenName",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "tokenSymbol",
				"type": "string"
			}
		],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "spender",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "value",
				"type": "uint256"
			}
		],
		"name": "Approval",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "account",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "oldBalance",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "newBalance",
				"type": "uint256"
			}
		],
		"name": "BalanceChanged",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "triggeredBy",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "EmergencyShutdown",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "protocol",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "canTransfer",
				"type": "bool"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "canSnapshot",
				"type": "bool"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "canModifyPermissions",
				"type": "bool"
			}
		],
		"name": "PermissionUpdated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "protocol",
				"type": "address"
			},
			{
				"components": [
					{
						"internalType": "bool",
						"name": "canTransfer",
						"type": "bool"
					},
					{
						"internalType": "bool",
						"name": "canSnapshot",
						"type": "bool"
					},
					{
						"internalType": "bool",
						"name": "canModifyPermissions",
						"type": "bool"
					},
					{
						"internalType": "uint256",
						"name": "lastUpdated",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "deregistrationTime",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "lastSnapshotTime",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "snapshotCount",
						"type": "uint256"
					}
				],
				"indexed": true,
				"internalType": "struct wCIFI.ProtocolPermissions",
				"name": "permissions",
				"type": "tuple"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "effectiveTime",
				"type": "uint256"
			}
		],
		"name": "ProtocolStatusChanged",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "oldLimit",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "newLimit",
				"type": "uint256"
			}
		],
		"name": "RateLimitUpdated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "attacker",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "functionName",
				"type": "string"
			}
		],
		"name": "ReentrancyAttempt",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "requester",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "batchSize",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "success",
				"type": "bool"
			}
		],
		"name": "SnapshotAttempt",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "bytes32",
				"name": "snapshotId",
				"type": "bytes32"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "blockNumber",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "SnapshotCreated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "bytes32",
				"name": "snapshotId",
				"type": "bytes32"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "SnapshotPruned",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "value",
				"type": "uint256"
			}
		],
		"name": "Transfer",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "spender",
				"type": "address"
			}
		],
		"name": "allowance",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "spender",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "value",
				"type": "uint256"
			}
		],
		"name": "approve",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "balanceOf",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			},
			{
				"internalType": "bytes32",
				"name": "snapshotId",
				"type": "bytes32"
			}
		],
		"name": "balanceOfAt",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address[]",
				"name": "addresses",
				"type": "address[]"
			}
		],
		"name": "createSnapshot",
		"outputs": [
			{
				"internalType": "bytes32",
				"name": "",
				"type": "bytes32"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "decimals",
		"outputs": [
			{
				"internalType": "uint8",
				"name": "",
				"type": "uint8"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "emergencyShutdown",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "spender",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "value",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "nonce",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "deadline",
				"type": "uint256"
			}
		],
		"name": "getPermitHash",
		"outputs": [
			{
				"internalType": "bytes32",
				"name": "",
				"type": "bytes32"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "protocol",
				"type": "address"
			}
		],
		"name": "getProtocolPermissions",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "protocol",
				"type": "address"
			}
		],
		"name": "initiateProtocolDeregistration",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "protocol",
				"type": "address"
			}
		],
		"name": "isProtocolActive",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "name",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "nonces",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "paused",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "spender",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "value",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "deadline",
				"type": "uint256"
			},
			{
				"internalType": "uint8",
				"name": "v",
				"type": "uint8"
			},
			{
				"internalType": "bytes32",
				"name": "r",
				"type": "bytes32"
			},
			{
				"internalType": "bytes32",
				"name": "s",
				"type": "bytes32"
			}
		],
		"name": "permit",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "protocol",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "canTransfer",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "canSnapshot",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "canModifyPermissions",
				"type": "bool"
			}
		],
		"name": "registerProtocol",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "symbol",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "totalSupply",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "value",
				"type": "uint256"
			}
		],
		"name": "transfer",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "value",
				"type": "uint256"
			}
		],
		"name": "transferFrom",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "protocol",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "canTransfer",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "canSnapshot",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "canModifyPermissions",
				"type": "bool"
			}
		],
		"name": "updateProtocolPermissions",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	}
];

    let web3;
    let contract;
    let currentAccount;
    let currentChainId;
    let products = [];

    const NETWORKS = {
      50: {
        name: 'XDC Mainnet',
        rpcUrl: 'https://rpc.xinfin.network',
        contractAddress: '0xf2CC1c24d2b1E173020ab9b846e8bfFD78f6976b',
        symbol: 'XDC',
        explorer: 'https://explorer.xinfin.network',
        chainParams: {
          chainId: '0x32',
          chainName: 'XDC Mainnet',
          nativeCurrency: { name: 'XDC', symbol: 'XDC', decimals: 18 },
          rpcUrls: ['https://rpc.xinfin.network'],
          blockExplorerUrls: ['https://explorer.xinfin.network']
        }
      },
      43114: {
        name: 'Avalanche C-Chain',
        rpcUrl: 'https://api.avax.network/ext/bc/C/rpc',
        contractAddress: '0xf2CC1c24d2b1E173020ab9b846e8bfFD78f6976b',
        symbol: 'AVAX',
        explorer: 'https://snowtrace.io',
        chainParams: {
          chainId: '0xA86A',
          chainName: 'Avalanche C-Chain',
          nativeCurrency: { name: 'AVAX', symbol: 'AVAX', decimals: 18 },
          rpcUrls: ['https://api.avax.network/ext/bc/C/rpc'],
          blockExplorerUrls: ['https://snowtrace.io']
        }
      },
      137: {
        name: 'Polygon Mainnet',
        rpcUrl: 'https://polygon-rpc.com',
        contractAddress: '0xf2CC1c24d2b1E173020ab9b846e8bfFD78f6976b',
        symbol: 'POL',
        explorer: 'https://polygonscan.com',
        chainParams: {
          chainId: '0x89',
          chainName: 'Polygon Mainnet',
          nativeCurrency: { name: 'POL', symbol: 'POL', decimals: 18 },
          rpcUrls: ['https://polygon-rpc.com'],
          blockExplorerUrls: ['https://polygonscan.com']
        }
      }
    };

    // Initialize Web3 and connect to the wallet
    async function connectWallet() {
      if (typeof window.ethereum !== 'undefined') {
        try {
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          currentAccount = accounts[0];

          web3 = new Web3(window.ethereum);

          const chainId = await web3.eth.getChainId();
          await handleNetworkChange(chainId);

          window.ethereum.on('accountsChanged', handleAccountChange);
          window.ethereum.on('chainChanged', handleNetworkChange);

          document.getElementById('wallet-status').innerHTML = 
            `<span>Connected: ${currentAccount.substr(0,6)}...${currentAccount.substr(-4)}</span>`;

          showNotification('success', 'Connected', 'Successfully connected to wallet');
        } catch (error) {
          console.error('Error connecting to wallet:', error);
          showNotification('error', 'Connection Failed', formatError(error));
        }
      } else {
        showNotification('error', 'Web3 Not Found', 'Please install MetaMask');
      }
    }

    document.getElementById('connect-wallet-btn').addEventListener('click', connectWallet);

    async function handleAccountChange(accounts) {
      if (accounts.length === 0) {
        currentAccount = null;
        document.getElementById('wallet-status').innerHTML = 
          `<button class="btn btn-primary" id="connect-wallet-btn">Connect Wallet</button>`;
        document.getElementById('connect-wallet-btn').addEventListener('click', connectWallet);
        showNotification('warning', 'Disconnected', 'Please connect your wallet');
      } else {
        currentAccount = accounts[0];
        document.getElementById('wallet-status').innerHTML = 
          `<span>Connected: ${currentAccount.substr(0,6)}...${currentAccount.substr(-4)}</span>`;
        await loadProducts();
      }
    }

    async function handleNetworkChange(chainId) {
      currentChainId = parseInt(chainId, 16);
      const networkConfig = NETWORKS[currentChainId];

      if (!networkConfig) {
        showNotification('error', 'Network Error', 'Unsupported network. Please switch to a supported network.');
        return;
      }

      document.getElementById('network-status').textContent = `Network: ${networkConfig.name}`;
      contract = new web3.eth.Contract(CONTRACT_ABI, networkConfig.contractAddress);

      await loadProducts();
    }

    async function loadProducts() {
      try {
        const productIds = await contract.methods.getAllProductIds().call();
        products = [];

        for (let i = 0; i < productIds.length; i++) {
          const productId = productIds[i];
          const [basicInfo, fullDetails] = await Promise.all([
            contract.methods.getProductBasicInfo(productId).call(),
            contract.methods.getFullProductDetails(productId).call()
          ]);

          if (basicInfo.isActive && !basicInfo.emergencyLocked) {
            const product = {
              id: productId,
              name: basicInfo.name,
              ipfsCID: basicInfo.ipfsCID,
              productContractAddress: basicInfo.productContract,
              price: fullDetails.price,
              paymentToken: fullDetails.paymentToken,
              availableSupply: fullDetails.availableSupply,
            };
            products.push(product);
          }
        }

        renderProducts();
      } catch (error) {
        showNotification('error', 'Loading Error', formatError(error));
      }
    }

    function renderProducts() {
      const productListing = document.getElementById('product-listing');
      productListing.innerHTML = '';

      if (products.length === 0) {
        productListing.innerHTML = '<p>No products available at the moment.</p>';
        return;
      }

      products.forEach(product => {
        const productCard = document.createElement('div');
        productCard.className = 'product-card';

        const imageUrl = `https://ipfs.io/ipfs/${product.ipfsCID}`;
        const priceInEth = web3.utils.fromWei(product.price);

        productCard.innerHTML = `
          <h3>${product.name}</h3>
          <div class="product-image">
            <img src="${imageUrl}" alt="${product.name}" onerror="this.onerror=null; this.src='placeholder.png';">
          </div>
          <p class="price">${priceInEth} ${NETWORKS[currentChainId].symbol}</p>
          <button class="btn btn-primary" onclick="showPurchaseModal(${product.id})">Buy Now</button>
        `;

        productListing.appendChild(productCard);
      });
    }

    function showPurchaseModal(productId) {
      const product = products.find(p => p.id == productId);
      if (!product) {
        showNotification('error', 'Error', 'Product not found');
        return;
      }

      const priceInEth = web3.utils.fromWei(product.price);

      document.getElementById('purchase-product-details').innerHTML = `
        <h3>${product.name}</h3>
        <div class="product-image">
          <img src="https://ipfs.io/ipfs/${product.ipfsCID}" alt="${product.name}" onerror="this.onerror=null; this.src='placeholder.png';">
        </div>
        <p class="price">${priceInEth} ${NETWORKS[currentChainId].symbol} per unit</p>
        <p>Available Supply: ${product.availableSupply}</p>
      `;

      document.getElementById('purchase-form').onsubmit = async function(e) {
        e.preventDefault();
        const amount = e.target.elements['amount'].value;
        await purchaseProduct(productId, amount);
      };

      showModal('purchase-modal');
    }

    async function purchaseProduct(productId, amount) {
      const product = products.find(p => p.id == productId);
      if (!product) {
        showNotification('error', 'Error', 'Product not found');
        return;
      }

      if (!currentAccount) {
        showNotification('error', 'Error', 'Please connect your wallet');
        return;
      }

      try {
        const paymentAmount = web3.utils.toBN(product.price).mul(web3.utils.toBN(amount));
        const productContract = new web3.eth.Contract(CONTRACT_ABI, product.productContractAddress);

        if (product.paymentToken === '0x0000000000000000000000000000000000000000') {
          // Payment in native currency
          await productContract.methods.purchaseProduct(amount).send({
            from: currentAccount,
            value: paymentAmount.toString()
          });
        } else {
          // Payment in ERC20 token
          const paymentTokenContract = new web3.eth.Contract(ERC20_ABI, product.paymentToken);
          await paymentTokenContract.methods.approve(product.productContractAddress, paymentAmount.toString()).send({ from: currentAccount });
          await productContract.methods.purchaseProduct(amount).send({ from: currentAccount });
        }

        closeModal('purchase-modal');
        showNotification('success', 'Success', 'Purchase successful');
        await loadProducts();
      } catch (error) {
        showNotification('error', 'Purchase Failed', formatError(error));
      }
    }

    function showNotification(type, title, message) {
      const notification = document.createElement('div');
      notification.className = `notification ${type} show`;
      notification.innerHTML = `
        <div class="notification-content">
          <div class="notification-title">${title}</div>
          <div class="notification-message">${message}</div>
        </div>
        <button class="notification-close" onclick="this.parentElement.remove()">×</button>
      `;

      document.body.appendChild(notification);
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    }

    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.add('show');
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.remove('show');
    }

    function formatError(error) {
      if (error.message) {
        if (error.message.includes('User denied')) {
          return 'Transaction rejected by user';
        }
        if (error.message.includes('insufficient funds')) {
          return 'Insufficient funds for transaction';
        }
        return error.message;
      }
      return 'An unexpected error occurred';
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (typeof window.ethereum !== 'undefined') {
        web3 = new Web3(window.ethereum);
        web3.eth.getAccounts().then(accounts => {
          if (accounts.length > 0) {
            currentAccount = accounts[0];
            document.getElementById('wallet-status').innerHTML = 
              `<span>Connected: ${currentAccount.substr(0,6)}...${currentAccount.substr(-4)}</span>`;
            web3.eth.getChainId().then(chainId => {
              handleNetworkChange(chainId);
            });
          }
        });

        window.ethereum.on('accountsChanged', handleAccountChange);
        window.ethereum.on('chainChanged', handleNetworkChange);
      } else {
        console.warn('MetaMask is not installed');
      }
    });
  </script>
</body>
</html>
