<html><head><base href="/" />
<title>Multi-Chain DApp</title>
<script src="https://cdn.jsdelivr.net/npm/web3@1.6.0/dist/web3.min.js"></script>
<style>
/* Reset styles for consistency */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html, body {
    height: 100%;
    width: 100%;
    overflow-x: hidden;
}

:root {
    --primary: #2D3748;
    --secondary: #4A5568;
    --accent: #6B46C1;
    --sidebar-width: 200px;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, sans-serif;
    background: #f7fafc;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    width: 100vw;
    overflow-x: hidden;
}

.container {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    width: 90%;
    max-width: 1200px;
    min-height: fit-content;
    height: 80vh;
    max-height: 600px;
    display: flex;
    overflow: auto;
    margin: auto;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.sidebar {
    width: var(--sidebar-width);
    background: var(--primary);
    padding: 2rem 1rem;
    border-radius: 16px 0 0 16px;
    color: white;
    position: relative;
    min-height: 500px;
    display: flex;
    flex-direction: column;
}

.main-content {
    flex: 1;
    padding: 2rem;
    position: relative;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--secondary) transparent;
}

.header {
    text-align: center;
    margin-bottom: 2rem;
}

.header h1 {
    margin-bottom: 0.5rem;
    color: var(--primary);
}

.header p {
    color: var(--secondary);
    margin-bottom: 2rem;
}

.network-btn {
    width: 100%;
    padding: 1rem;
    margin-bottom: 1rem;
    border: none;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: left;
}

.network-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateX(5px);
}

.network-btn.active {
    background: #000000;
    border: 2px solid #40E0D0;
    box-shadow: 0 4px 6px rgba(64, 224, 208, 0.2);
}

.products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
}

.product-card {
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    background: #f8fafc;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.product-info {
    margin-bottom: 1rem;
    width: 100%;
    text-align: center;
}

.product-info h2 {
    color: var(--primary);
    margin-bottom: 0.5rem;
    text-align: center;
}

.product-info p {
    color: var(--secondary);
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
    text-align: center;
}

.quantity-selector {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin: 1rem 0;
    justify-content: center;
}

.quantity-btn {
    background: var(--secondary);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 0.5rem 1rem;
    cursor: pointer;
}

.buy-btn {
    background: #000000;
    color: white;
    border: 2px solid #40E0D0;
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    cursor: pointer;
    width: 100%;
    font-weight: bold;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(64, 224, 208, 0.2);
}

.buy-btn:hover {
    background: #333333;
    box-shadow: 0 6px 8px rgba(64, 224, 208, 0.3);
}

.logo-container {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 120px;
    height: 120px;
    display: flex;
    justify-content: center;
    align-items: center;
}

.logo {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #40E0D0;
    box-shadow: 0 4px 6px rgba(64, 224, 208, 0.2);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.logo:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 8px rgba(64, 224, 208, 0.3);
}

#wallet-status {
    font-size: 0.9rem;
    margin-bottom: 1rem;
    color: white;
    text-align: center;
}

.contract-address {
    font-size: 0.8rem;
    color: var(--secondary);
    word-break: break-all;
    text-align: center;
    width: 100%;
}

.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    max-width: 300px;
    z-index: 1000;
    padding: 10px;
}

.custom-toast {
    background: white;
    color: #2D3748;
    padding: 12px 20px;
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    justify-content: space-between;
    animation: slideIn 0.3s ease-out;
    border-left: 4px solid;
}

.custom-toast.success {
    border-left-color: #48BB78;
}

.custom-toast.error {
    border-left-color: #F56565;
}

/* Enhanced scrollbar styling */
.main-content::-webkit-scrollbar {
    width: 8px;
}

.main-content::-webkit-scrollbar-track {
    background: transparent;
}

.main-content::-webkit-scrollbar-thumb {
    background-color: var(--secondary);
    border-radius: 4px;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Responsive adjustments */
@media screen and (max-width: 1024px) {
    .container {
        width: 95%;
        height: 85vh;
    }
}

@media screen and (max-width: 768px) {
    .container {
        width: 98%;
        height: 90vh;
    }
    
    .sidebar {
        width: 160px;
    }
    
    .products-grid {
        grid-template-columns: 1fr;
    }
}
</style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div id="wallet-status">Wallet not connected</div>
            <button class="network-btn" data-network="xdc">XDC Network</button>
            <button class="network-btn" data-network="avax">Avalanche</button>
            <button class="network-btn" data-network="polygon">Polygon</button>
            <div class="logo-container">
                <img src="https://ipfs.io/ipfs/QmQX4HvtqdYVuJHm17JTyGkK1ttFitg4oAhPzXdy6psm1T" alt="Logo" class="logo">
            </div>
            <!-- Role-Based Actions -->
            <div id="owner-actions" class="role-actions" style="display: none;">
                <h3>Owner Actions</h3>
                <button id="whitelist-creator-btn">Whitelist Creator</button>
                <button id="pause-contract-btn">Pause Contract</button>
                <button id="unpause-contract-btn">Unpause Contract</button>
            </div>
            <div id="creator-actions" class="role-actions" style="display: none;">
                <h3>Creator Actions</h3>
                <button id="add-product-btn">Add Product</button>
            </div>
        </div>

        <div class="main-content">
            <div class="header">
                <h1>CIFI Cross-Chain Vending Machine</h1>
                <p>Purchase tokens across multiple networks seamlessly. Connect your wallet by selecting a network from the sidebar.</p>
            </div>

            <div id="products-grid" class="products-grid">
                <!-- Products will be dynamically populated here -->
            </div>

            <!-- Modals for Owner and Creator Actions -->
            <!-- Whitelist Creator Modal -->
            <div id="whitelist-creator-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close-btn" data-modal-id="whitelist-creator-modal">&times;</span>
                    <h2>Whitelist Creator</h2>
                    <input type="text" id="creator-address-input" placeholder="Creator Address">
                    <button id="confirm-whitelist-btn">Whitelist</button>
                </div>
            </div>

            <!-- Add Product Modal -->
            <div id="add-product-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close-btn" data-modal-id="add-product-modal">&times;</span>
                    <h2>Add New Product</h2>
                    <input type="text" id="product-name-input" placeholder="Product Name">
                    <input type="text" id="product-ipfs-cid-input" placeholder="IPFS CID">
                    <input type="text" id="product-token-address-input" placeholder="Product Token Address">
                    <input type="text" id="payment-token-address-input" placeholder="Payment Token Address (Leave blank for native token)">
                    <input type="number" id="product-price-input" placeholder="Price per Unit" step="any">
                    <input type="number" id="product-initial-supply-input" placeholder="Initial Supply" step="any">
                    <input type="text" id="product-beneficiary-input" placeholder="Beneficiary Address">
                    <button id="confirm-add-product-btn">Add Product</button>
                </div>
            </div>

            <!-- Update Product Modal -->
            <div id="update-product-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close-btn" data-modal-id="update-product-modal">&times;</span>
                    <h2>Update Product</h2>
                    <input type="number" id="update-product-price-input" placeholder="New Price" step="any">
                    <input type="text" id="update-product-ipfs-cid-input" placeholder="New IPFS CID">
                    <button id="confirm-update-product-btn">Update Product</button>
                </div>
            </div>

            <!-- Toast Notifications -->
            <div class="toast-container" id="toast-container">
                <!-- Notifications will be shown here -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Network configurations
        const networks = {
            xdc: {
                name: 'XDC Mainnet',
                chainId: '0x32',
                rpcUrl: 'https://rpc.xinfin.network',
                symbol: 'XDC',
                explorer: 'https://explorer.xinfin.network',
                contractAddress: '<0x1aa50dAe8DE411c71db6A77e2C0A9ceE35C8BBd1>',
                vendingMachineContract: null,
                erc20Abi: [
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_symbol",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "_tokenSupply",
				"type": "uint256"
			}
		],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "spender",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "value",
				"type": "uint256"
			}
		],
		"name": "Approval",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "Mint",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "MinterAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "MinterRemoved",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "value",
				"type": "uint256"
			}
		],
		"name": "Transfer",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "addMinter",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "spender",
				"type": "address"
			}
		],
		"name": "allowance",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "spender",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "approve",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "balanceOf",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_account",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "_amount",
				"type": "uint256"
			}
		],
		"name": "burnCIFIToken",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "decimals",
		"outputs": [
			{
				"internalType": "uint8",
				"name": "",
				"type": "uint8"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "spender",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "subtractedValue",
				"type": "uint256"
			}
		],
		"name": "decreaseAllowance",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "spender",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "addedValue",
				"type": "uint256"
			}
		],
		"name": "increaseAllowance",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "isMinter",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_account",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "_amount",
				"type": "uint256"
			}
		],
		"name": "mintCIFIToken",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "name",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "renounceMinter",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "symbol",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "tokenSupply",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "totalSupply",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "transfer",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "transferFrom",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	}
]
            },
            avax: {
                name: 'Avalanche C-Chain',
                chainId: '0xA86A',
                rpcUrl: 'https://api.avax.network/ext/bc/C/rpc',
                symbol: 'AVAX',
                explorer: 'https://snowtrace.io',
                contractAddress: '<0xe90bCeef5AC65a36199Cfa29552FBCF36BE531A0>',
                vendingMachineContract: null,
                erc20Abi: [/* ERC20 ABI Placeholder */]
            },
            polygon: {
                name: 'Polygon Mainnet',
                chainId: '0x89',
                rpcUrl: 'https://polygon-rpc.com',
                symbol: 'POL',
                explorer: 'https://polygonscan.com',
                contractAddress: '<POLYGON_CONTRACT_ADDRESS>',
                vendingMachineContract: null,
                erc20Abi: [/* ERC20 ABI Placeholder */]
            }
        };

        // Contract ABIs
        const vendingMachineABI = [
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "OwnableInvalidOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "OwnableUnauthorizedAccount",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "token",
				"type": "address"
			}
		],
		"name": "SafeERC20FailedOperation",
		"type": "error"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "creator",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "status",
				"type": "bool"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "CreatorWhitelisted",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "creator",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "EmergencyWithdrawalExecuted",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "creator",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "EmergencyWithdrawalRequested",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "Paused",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "ipfsCID",
				"type": "string"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "productToken",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "paymentToken",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "creator",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "beneficiary",
				"type": "address"
			}
		],
		"name": "ProductAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "locked",
				"type": "bool"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "ProductEmergencyLocked",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "paymentAmount",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "ProductPurchased",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "isActive",
				"type": "bool"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "ProductStatusChanged",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "newPrice",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "newIpfsCID",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "updater",
				"type": "address"
			}
		],
		"name": "ProductUpdated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "token",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "TokensWithdrawn",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "Unpaused",
		"type": "event"
	},
	{
		"stateMutability": "payable",
		"type": "fallback"
	},
	{
		"inputs": [],
		"name": "EMERGENCY_WITHDRAWAL_DELAY",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "ipfsCID",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "productToken",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "paymentToken",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "beneficiary",
				"type": "address"
			}
		],
		"name": "addProduct",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "emergencyWithdrawalRequested",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "emergencyWithdrawalTime",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			}
		],
		"name": "executeEmergencyWithdrawal",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getProductCount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			}
		],
		"name": "getProductDetails",
		"outputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "ipfsCID",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "productToken",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "paymentToken",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "availableSupply",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "isActive",
				"type": "bool"
			},
			{
				"internalType": "uint256",
				"name": "totalSold",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "totalRevenue",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "creator",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "beneficiary",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "emergencyLocked",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			}
		],
		"name": "getProductRevenue",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "totalSold",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "totalRevenue",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "creator",
				"type": "address"
			}
		],
		"name": "isWhitelistedCreator",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "pause",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "paused",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "products",
		"outputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "ipfsCID",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "productToken",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "paymentToken",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "isActive",
				"type": "bool"
			},
			{
				"internalType": "uint256",
				"name": "totalSold",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "totalRevenue",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "creator",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "beneficiary",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "emergencyLocked",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "purchaseProduct",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "renounceOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			}
		],
		"name": "requestEmergencyWithdrawal",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "creator",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "status",
				"type": "bool"
			}
		],
		"name": "setCreatorWhitelist",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "isActive",
				"type": "bool"
			}
		],
		"name": "setProductStatus",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "unpause",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "newPrice",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "newIpfsCID",
				"type": "string"
			}
		],
		"name": "updateProduct",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "whitelistedCreators",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "token",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "withdrawTokens",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"stateMutability": "payable",
		"type": "receive"
	}
];
        const standardERC20ABI = [
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "tokenName",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "tokenSymbol",
				"type": "string"
			}
		],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "spender",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "value",
				"type": "uint256"
			}
		],
		"name": "Approval",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "account",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "oldBalance",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "newBalance",
				"type": "uint256"
			}
		],
		"name": "BalanceChanged",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "triggeredBy",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "EmergencyShutdown",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "protocol",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "canTransfer",
				"type": "bool"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "canSnapshot",
				"type": "bool"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "canModifyPermissions",
				"type": "bool"
			}
		],
		"name": "PermissionUpdated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "protocol",
				"type": "address"
			},
			{
				"components": [
					{
						"internalType": "bool",
						"name": "canTransfer",
						"type": "bool"
					},
					{
						"internalType": "bool",
						"name": "canSnapshot",
						"type": "bool"
					},
					{
						"internalType": "bool",
						"name": "canModifyPermissions",
						"type": "bool"
					},
					{
						"internalType": "uint256",
						"name": "lastUpdated",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "deregistrationTime",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "lastSnapshotTime",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "snapshotCount",
						"type": "uint256"
					}
				],
				"indexed": true,
				"internalType": "struct wCIFI.ProtocolPermissions",
				"name": "permissions",
				"type": "tuple"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "effectiveTime",
				"type": "uint256"
			}
		],
		"name": "ProtocolStatusChanged",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "oldLimit",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "newLimit",
				"type": "uint256"
			}
		],
		"name": "RateLimitUpdated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "attacker",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "functionName",
				"type": "string"
			}
		],
		"name": "ReentrancyAttempt",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "requester",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "batchSize",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "success",
				"type": "bool"
			}
		],
		"name": "SnapshotAttempt",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "bytes32",
				"name": "snapshotId",
				"type": "bytes32"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "blockNumber",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "SnapshotCreated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "bytes32",
				"name": "snapshotId",
				"type": "bytes32"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "SnapshotPruned",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "value",
				"type": "uint256"
			}
		],
		"name": "Transfer",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "spender",
				"type": "address"
			}
		],
		"name": "allowance",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "spender",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "value",
				"type": "uint256"
			}
		],
		"name": "approve",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "balanceOf",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			},
			{
				"internalType": "bytes32",
				"name": "snapshotId",
				"type": "bytes32"
			}
		],
		"name": "balanceOfAt",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address[]",
				"name": "addresses",
				"type": "address[]"
			}
		],
		"name": "createSnapshot",
		"outputs": [
			{
				"internalType": "bytes32",
				"name": "",
				"type": "bytes32"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "decimals",
		"outputs": [
			{
				"internalType": "uint8",
				"name": "",
				"type": "uint8"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "emergencyShutdown",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "spender",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "value",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "nonce",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "deadline",
				"type": "uint256"
			}
		],
		"name": "getPermitHash",
		"outputs": [
			{
				"internalType": "bytes32",
				"name": "",
				"type": "bytes32"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "protocol",
				"type": "address"
			}
		],
		"name": "getProtocolPermissions",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "protocol",
				"type": "address"
			}
		],
		"name": "initiateProtocolDeregistration",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "protocol",
				"type": "address"
			}
		],
		"name": "isProtocolActive",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "name",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "nonces",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "paused",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "spender",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "value",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "deadline",
				"type": "uint256"
			},
			{
				"internalType": "uint8",
				"name": "v",
				"type": "uint8"
			},
			{
				"internalType": "bytes32",
				"name": "r",
				"type": "bytes32"
			},
			{
				"internalType": "bytes32",
				"name": "s",
				"type": "bytes32"
			}
		],
		"name": "permit",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "protocol",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "canTransfer",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "canSnapshot",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "canModifyPermissions",
				"type": "bool"
			}
		],
		"name": "registerProtocol",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "symbol",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "totalSupply",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "value",
				"type": "uint256"
			}
		],
		"name": "transfer",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "value",
				"type": "uint256"
			}
		],
		"name": "transferFrom",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "protocol",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "canTransfer",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "canSnapshot",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "canModifyPermissions",
				"type": "bool"
			}
		],
		"name": "updateProtocolPermissions",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	}
];

        let currentNetwork = null;
        let web3;
        let accounts = [];
        let userAddress = null;
        let isOwner = false;
        let isWhitelistedCreator = false;

        // Initialize Web3 and contract instances
        async function initializeWeb3(networkKey) {
            const network = networks[networkKey];

            if (typeof window.ethereum === 'undefined') {
                throw new Error('Please install MetaMask!');
            }

            web3 = new Web3(window.ethereum);

            // Initialize the vending machine contract instance
            network.vendingMachineContract = new web3.eth.Contract(
                vendingMachineABI,
                network.contractAddress
            );

            return network;
        }

        // Connect wallet and switch network
        async function connectWallet(networkKey) {
            try {
                const network = await initializeWeb3(networkKey);

                // Request account access
                accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];

                // Switch network
                await switchNetwork(networkKey);

                // Check user roles
                await checkUserRoles();

                // Update UI
                updateWalletStatus();
                updateRoleBasedUI();
                await loadProducts();

                showNotification('Wallet connected successfully!', 'success');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        // Switch network in MetaMask
        async function switchNetwork(networkKey) {
            try {
                const network = networks[networkKey];

                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: network.chainId,
                        chainName: network.name,
                        nativeCurrency: {
                            name: network.symbol,
                            symbol: network.symbol,
                            decimals: 18
                        },
                        rpcUrls: [network.rpcUrl],
                        blockExplorerUrls: [network.explorer]
                    }]
                });

                currentNetwork = networkKey;
                updateNetworkButtons();

            } catch (error) {
                throw new Error(`Failed to switch network: ${error.message}`);
            }
        }

        // Check if the user is the contract owner or a whitelisted creator
        async function checkUserRoles() {
            try {
                const network = networks[currentNetwork];
                const contract = network.vendingMachineContract;

                // Check if the user is the owner
                const ownerAddress = await contract.methods.owner().call();
                isOwner = (userAddress.toLowerCase() === ownerAddress.toLowerCase());

                // Check if the user is a whitelisted creator
                isWhitelistedCreator = await contract.methods.isWhitelistedCreator(userAddress).call();

            } catch (error) {
                console.error('Error checking user roles:', error);
            }
        }

        // Update UI based on user roles
        function updateRoleBasedUI() {
            const ownerActions = document.getElementById('owner-actions');
            const creatorActions = document.getElementById('creator-actions');

            if (isOwner) {
                ownerActions.style.display = 'block';
            } else {
                ownerActions.style.display = 'none';
            }

            if (isWhitelistedCreator) {
                creatorActions.style.display = 'block';
            } else {
                creatorActions.style.display = 'none';
            }
        }

        // Load products from smart contract
        async function loadProducts() {
            try {
                const network = networks[currentNetwork];
                const contract = network.vendingMachineContract;

                // Check if contract is properly initialized
                if (!contract || !contract.methods.getProductCount) {
                    throw new Error('Smart contract not initialized properly');
                }

                // Get product count
                const productCount = await contract.methods.getProductCount().call();

                // Clear existing products
                const productsGrid = document.getElementById('products-grid');
                productsGrid.innerHTML = '';

                // Load each product
                for (let i = 0; i < productCount; i++) {
                    try {
                        const productData = await contract.methods.getProductDetails(i).call();

                        const product = {
                            id: i,
                            name: productData.name,
                            ipfsCID: productData.ipfsCID,
                            productToken: productData.productToken,
                            paymentToken: productData.paymentToken,
                            price: productData.price,
                            availableSupply: productData.availableSupply,
                            isActive: productData.isActive,
                            totalSold: productData.totalSold,
                            totalRevenue: productData.totalRevenue,
                            creator: productData.creator,
                            beneficiary: productData.beneficiary,
                            emergencyLocked: productData.emergencyLocked
                        };

                        // Fetch payment token name
                        if (product.paymentToken === '0x0000000000000000000000000000000000000000') {
                            product.paymentTokenName = network.symbol; // Native token
                            product.paymentTokenDecimals = 18;
                        } else {
                            // Initialize ERC20 contract for the payment token
                            const erc20Abi = network.erc20Abi.length > 0 ? network.erc20Abi : standardERC20ABI;
                            const paymentTokenContract = new web3.eth.Contract(
                                erc20Abi,
                                product.paymentToken
                            );
                            product.paymentTokenName = await paymentTokenContract.methods.symbol().call();
                            product.paymentTokenDecimals = await paymentTokenContract.methods.decimals().call();
                        }

                        // Fetch product token decimals
                        const productTokenContract = new web3.eth.Contract(
                            standardERC20ABI,
                            product.productToken
                        );
                        product.productTokenDecimals = await productTokenContract.methods.decimals().call();

                        // Convert price and availableSupply to human-readable format
                        product.displayPrice = web3.utils.fromWei(product.price, 'ether');
                        product.displayAvailableSupply = web3.utils.fromWei(product.availableSupply, 'ether');

                        addProductToUI(product);
                    } catch (innerError) {
                        console.error(`Error loading product ${i}: ${innerError.message}`);
                    }
                }
            } catch (error) {
                showNotification('Error loading products: ' + error.message, 'error');
            }
        }

        // Add product to UI
        function addProductToUI(product) {
            const productsGrid = document.getElementById('products-grid');

            const productCard = document.createElement('div');
            productCard.className = 'product-card';
            productCard.innerHTML = `
                <div class="product-info">
                    <img src="https://ipfs.io/ipfs/${product.ipfsCID}" alt="${product.name}" class="product-image">
                    <h2>${product.name}</h2>
                    <p>Price: ${product.displayPrice} ${product.paymentTokenName}</p>
                    <p>Available: ${product.displayAvailableSupply}</p>
                    <p>Total Sold: ${web3.utils.fromWei(product.totalSold, 'ether')}</p>
                    <p>Creator: ${product.creator}</p>
                    <p>Beneficiary: ${product.beneficiary}</p>
                    ${product.emergencyLocked ? '<p class="emergency-lock">Emergency Locked</p>' : ''}
                    <p class="contract-address">Token: ${product.productToken}</p>
                </div>
                ${product.isActive && !product.emergencyLocked ? `
                    <div class="quantity-selector">
                        <input type="number" class="quantity-input" value="1" min="1" max="${product.displayAvailableSupply}" />
                    </div>
                    <button class="buy-btn" data-product-id="${product.id}">Buy Now</button>
                ` : '<p class="inactive-product">Product not available</p>'}
                ${isWhitelistedCreator && userAddress.toLowerCase() === product.creator.toLowerCase() ? `
                    <button class="update-product-btn" data-product-id="${product.id}">Update Product</button>
                    <button class="emergency-withdraw-btn" data-product-id="${product.id}">Emergency Withdraw</button>
                ` : ''}
            `;

            productsGrid.appendChild(productCard);

            // Add event listeners
            setupProductCardListeners(productCard, product);
        }

        // Setup product card event listeners
        function setupProductCardListeners(productCard, product) {
            const quantityInput = productCard.querySelector('.quantity-input');
            const buyBtn = productCard.querySelector('.buy-btn');
            const updateProductBtn = productCard.querySelector('.update-product-btn');
            const emergencyWithdrawBtn = productCard.querySelector('.emergency-withdraw-btn');

            if (quantityInput) {
                quantityInput.addEventListener('input', () => {
                    const currentQuantity = parseFloat(quantityInput.value);
                    const maxQuantity = parseFloat(product.displayAvailableSupply);
                    if (currentQuantity > maxQuantity) {
                        quantityInput.value = maxQuantity;
                    } else if (currentQuantity < 1) {
                        quantityInput.value = 1;
                    }
                });
            }

            if (buyBtn) {
                buyBtn.addEventListener('click', () => {
                    const quantity = parseFloat(quantityInput.value);
                    completePurchaseFlow(product.id, quantity);
                });
            }

            if (updateProductBtn) {
                updateProductBtn.addEventListener('click', () => {
                    openUpdateProductModal(product);
                });
            }

            if (emergencyWithdrawBtn) {
                emergencyWithdrawBtn.addEventListener('click', () => {
                    handleEmergencyWithdrawal(product.id);
                });
            }
        }

        // Purchase flow functions
        async function completePurchaseFlow(productId, amount) {
            try {
                const network = networks[currentNetwork];
                const contract = network.vendingMachineContract;

                // Perform pre-purchase validation
                const product = await performPrePurchaseChecks(productId, amount, web3, contract);

                // Execute purchase
                await handleProductPurchase(productId, amount, web3, contract);

                // Refresh UI/state after successful purchase
                await updateUIAfterPurchase(productId);

                return true;
            } catch (error) {
                handlePurchaseError(error);
            }
        }

        async function performPrePurchaseChecks(productId, amount, web3Instance, contract) {
            // Check if contract is paused
            const isPaused = await contract.methods.paused().call();
            if (isPaused) {
                throw new Error('Contract is paused');
            }

            // Get product details
            const product = await contract.methods.getProductDetails(productId).call();

            // Check if product is active
            if (!product.isActive) {
                throw new Error('Product is not active');
            }

            // Validate purchase amount
            validatePurchaseInput(amount, product.availableSupply, web3Instance);

            return product;
        }

        function validatePurchaseInput(amount, availableSupply, web3Instance) {
            const amountInWei = web3.utils.toWei(amount.toString(), 'ether');
            const supplyInWei = availableSupply;

            if (web3.utils.toBN(amountInWei).gt(web3.utils.toBN(supplyInWei))) {
                throw new Error('Purchase amount exceeds available supply');
            }

            if (web3.utils.toBN(amountInWei).lte(web3.utils.toBN('0'))) {
                throw new Error('Purchase amount must be greater than 0');
            }
        }

        async function handleProductPurchase(productId, amount, web3Instance, contract) {
            try {
                // Get current user's address
                const userAddress = accounts[0];

                // Get product details
                const product = await contract.methods.getProductDetails(productId).call();

                // Convert amount to wei (contract expects wei)
                const amountInWei = web3.utils.toWei(amount.toString(), 'ether');

                // Calculate payment amount
                const priceInWei = product.price;
                const paymentAmount = web3.utils.toBN(priceInWei)
                    .mul(web3.utils.toBN(amountInWei))
                    .div(web3.utils.toBN(web3.utils.toWei('1', 'ether'))); // Divide by 1e18 as per contract logic

                // Check if product uses native token (ETH/MATIC/etc) or ERC20
                if (product.paymentToken === '0x0000000000000000000000000000000000000000') {
                    // Native token payment
                    await contract.methods.purchaseProduct(productId, amountInWei)
                        .send({
                            from: userAddress,
                            value: paymentAmount.toString(),
                            gas: 300000 // Adjust based on network
                        });
                } else {
                    // ERC20 token payment
                    // First approve the contract to spend tokens
                    const erc20Abi = networks[currentNetwork].erc20Abi.length > 0 ? networks[currentNetwork].erc20Abi : standardERC20ABI;
                    const paymentToken = new web3Instance.eth.Contract(
                        erc20Abi,
                        product.paymentToken
                    );

                    // Check user's token balance
                    const userBalance = await paymentToken.methods.balanceOf(userAddress).call();
                    if (web3.utils.toBN(userBalance).lt(paymentAmount)) {
                        throw new Error('Insufficient token balance for purchase');
                    }

                    // Approve the vending machine contract to spend tokens
                    await paymentToken.methods.approve(contract.options.address, paymentAmount.toString())
                        .send({
                            from: userAddress,
                            gas: 60000
                        });

                    // Then make the purchase
                    await contract.methods.purchaseProduct(productId, amountInWei)
                        .send({
                            from: userAddress,
                            gas: 300000
                        });
                }

                return true;
            } catch (error) {
                console.error('Purchase failed:', error);
                throw error;
            }
        }

        async function updateUIAfterPurchase(productId) {
            await loadProducts(); // Refresh product list
            showNotification('Purchase successful!', 'success');
        }

        function handlePurchaseError(error) {
            let errorMessage = 'Purchase failed: ';

            if (error.code === 4001) {
                errorMessage += 'Transaction rejected by user';
            } else if (error.message.includes('insufficient funds')) {
                errorMessage += 'Insufficient funds for purchase';
            } else {
                errorMessage += error.message;
            }

            showNotification(errorMessage, 'error');
        }

        // Owner Actions
        // Whitelist Creator
        document.getElementById('whitelist-creator-btn').addEventListener('click', () => {
            openModal('whitelist-creator-modal');
        });

        document.getElementById('confirm-whitelist-btn').addEventListener('click', async () => {
            const creatorAddress = document.getElementById('creator-address-input').value.trim();
            if (!web3.utils.isAddress(creatorAddress)) {
                showNotification('Invalid address', 'error');
                return;
            }
            await whitelistCreator(creatorAddress);
            closeModal('whitelist-creator-modal');
        });

        // Pause and Unpause Contract
        document.getElementById('pause-contract-btn').addEventListener('click', async () => {
            await toggleContractPause(true);
        });

        document.getElementById('unpause-contract-btn').addEventListener('click', async () => {
            await toggleContractPause(false);
        });

        // Creator Actions
        // Add Product
        document.getElementById('add-product-btn').addEventListener('click', () => {
            openModal('add-product-modal');
        });

        document.getElementById('confirm-add-product-btn').addEventListener('click', async () => {
            await addNewProduct();
            closeModal('add-product-modal');
        });

        // Update Product
        function openUpdateProductModal(product) {
            openModal('update-product-modal');
            document.getElementById('update-product-price-input').value = web3.utils.fromWei(product.price, 'ether');
            document.getElementById('update-product-ipfs-cid-input').value = product.ipfsCID;
            document.getElementById('confirm-update-product-btn').dataset.productId = product.id;
        }

        document.getElementById('confirm-update-product-btn').addEventListener('click', async () => {
            const productId = document.getElementById('confirm-update-product-btn').dataset.productId;
            await updateProduct(productId);
            closeModal('update-product-modal');
        });

        async function updateProduct(productId) {
            try {
                const newPrice = document.getElementById('update-product-price-input').value.trim();
                const newIpfsCID = document.getElementById('update-product-ipfs-cid-input').value.trim();

                const network = networks[currentNetwork];
                const contract = network.vendingMachineContract;

                let newPriceInWei = '0';
                if (newPrice) {
                    newPriceInWei = web3.utils.toWei(newPrice.toString(), 'ether');
                }

                await contract.methods.updateProduct(
                    productId,
                    newPriceInWei,
                    newIpfsCID
                ).send({ from: userAddress });

                showNotification('Product updated successfully!', 'success');
                await loadProducts();
            } catch (error) {
                console.error('Error updating product:', error);
                showNotification('Error updating product: ' + error.message, 'error');
            }
        }

        // Handle Emergency Withdrawal
        async function handleEmergencyWithdrawal(productId) {
            try {
                const network = networks[currentNetwork];
                const contract = network.vendingMachineContract;

                // Request Emergency Withdrawal
                await contract.methods.requestEmergencyWithdrawal(productId)
                    .send({ from: userAddress });

                showNotification('Emergency withdrawal requested. You can execute it after the delay period.', 'success');
            } catch (error) {
                console.error('Error requesting emergency withdrawal:', error);
                showNotification('Error requesting emergency withdrawal: ' + error.message, 'error');
            }
        }

        // Helper Functions
        async function whitelistCreator(creatorAddress) {
            try {
                const network = networks[currentNetwork];
                const contract = network.vendingMachineContract;

                await contract.methods.setCreatorWhitelist(creatorAddress, true)
                    .send({ from: userAddress });

                showNotification('Creator whitelisted successfully!', 'success');
            } catch (error) {
                console.error('Error whitelisting creator:', error);
                showNotification('Error whitelisting creator: ' + error.message, 'error');
            }
        }

        async function toggleContractPause(pause) {
            try {
                const network = networks[currentNetwork];
                const contract = network.vendingMachineContract;

                if (pause) {
                    await contract.methods.pause().send({ from: userAddress });
                    showNotification('Contract paused successfully!', 'success');
                } else {
                    await contract.methods.unpause().send({ from: userAddress });
                    showNotification('Contract unpaused successfully!', 'success');
                }
            } catch (error) {
                console.error('Error toggling contract pause:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        async function addNewProduct() {
            try {
                const name = document.getElementById('product-name-input').value.trim();
                const ipfsCID = document.getElementById('product-ipfs-cid-input').value.trim();
                const productToken = document.getElementById('product-token-address-input').value.trim();
                let paymentToken = document.getElementById('payment-token-address-input').value.trim();
                const price = document.getElementById('product-price-input').value.trim();
                const initialSupply = document.getElementById('product-initial-supply-input').value.trim();
                const beneficiary = document.getElementById('product-beneficiary-input').value.trim();

                if (!name || !ipfsCID || !productToken || !price || !initialSupply || !beneficiary) {
                    showNotification('Please fill in all required fields', 'error');
                    return;
                }

                if (!web3.utils.isAddress(productToken) || !web3.utils.isAddress(beneficiary)) {
                    showNotification('Invalid address provided', 'error');
                    return;
                }

                if (!paymentToken) {
                    paymentToken = '0x0000000000000000000000000000000000000000'; // Native token
                } else if (!web3.utils.isAddress(paymentToken)) {
                    showNotification('Invalid payment token address', 'error');
                    return;
                }

                const network = networks[currentNetwork];
                const contract = network.vendingMachineContract;

                const priceInWei = web3.utils.toWei(price.toString(), 'ether');
                const initialSupplyInWei = web3.utils.toWei(initialSupply.toString(), 'ether');

                await contract.methods.addProduct(
                    name,
                    ipfsCID,
                    productToken,
                    paymentToken,
                    priceInWei,
                    initialSupplyInWei,
                    beneficiary
                ).send({ from: userAddress });

                showNotification('Product added successfully!', 'success');
                await loadProducts();
            } catch (error) {
                console.error('Error adding product:', error);
                showNotification('Error adding product: ' + error.message, 'error');
            }
        }

        // Modal Functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'block';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let modal of modals) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            }
        };

        // Close modal buttons
        document.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', (event) => {
                const modalId = event.target.dataset.modalId;
                closeModal(modalId);
            });
        });

        // UI Helper Functions
        function updateWalletStatus() {
            const statusDiv = document.getElementById('wallet-status');
            if (accounts && accounts.length > 0) {
                statusDiv.textContent = `Connected: ${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;
            } else {
                statusDiv.textContent = 'Wallet not connected';
            }
        }

        function updateNetworkButtons() {
            document.querySelectorAll('.network-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.network === currentNetwork);
            });
        }

        function showNotification(message, type) {
            const toastContainer = document.getElementById('toast-container');

            const toast = document.createElement('div');
            toast.className = `custom-toast ${type}`;
            toast.textContent = message;

            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    toastContainer.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // Event Listeners
        document.querySelectorAll('.network-btn').forEach(button => {
            button.addEventListener('click', () => {
                connectWallet(button.dataset.network);
            });
        });

        // MetaMask Events
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', async (newAccounts) => {
                accounts = newAccounts;
                userAddress = accounts[0];
                updateWalletStatus();
                if (accounts.length > 0 && currentNetwork) {
                    await checkUserRoles();
                    updateRoleBasedUI();
                    await loadProducts();
                }
            });

            window.ethereum.on('chainChanged', () => {
                window.location.reload();
            });
        }
    </script>
</body>
</html>
